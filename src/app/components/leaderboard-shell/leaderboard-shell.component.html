<div class="lb-shell">
  <div class="topbar" *ngIf="showTopbar">
    <ion-button class="back-btn" fill="clear" (click)="back.emit()">
      <ion-icon name="arrow-back-outline"></ion-icon>
    </ion-button>
    <div class="title-pill">{{ title }}</div>
    <ion-button
      *ngIf="showActionButton; else topbarSpacer"
      class="action-btn"
      fill="clear"
      [attr.aria-label]="actionAriaLabel"
      (click)="actionClick.emit()"
    >
      <ion-icon [name]="actionIconName"></ion-icon>
    </ion-button>
    <ng-template #topbarSpacer>
      <div class="topbar-spacer" aria-hidden="true"></div>
    </ng-template>
  </div>

  <ion-card class="stats-card">
    <div class="stats-title">Stats</div>
    <div class="stats-graph">
      <div class="graph-region-label">{{ graphLabel }}</div>
      <div class="graph-placeholder" #chartHost>
        <ng-container *ngIf="distributionChartResults.length > 0; else noChartData">
          <ngx-charts-area-chart
            class="distribution-ngx-chart"
            [results]="distributionChartResults"
            [view]="chartView"
            [scheme]="chartColorScheme"
            [schemeType]="chartScaleType"
            [legend]="false"
            [xAxis]="false"
            [yAxis]="false"
            [showGridLines]="false"
            [gradient]="true"
            [autoScale]="true"
            [timeline]="false"
            [animations]="true"
            [tooltipDisabled]="true"
          ></ngx-charts-area-chart>

          <div class="distribution-point-overlay">
            <button
              *ngFor="let point of distributionPoints; trackBy: trackByDistributionPoint"
              type="button"
              class="distribution-point"
              [class.point-selected]="isPointSelected(point)"
              [class.point-single]="point.count <= 1"
              [style.left.%]="point.xPercent"
              [style.top.%]="point.yPercent"
              [attr.title]="point.rangeLabel + ' (' + point.count + ' players)'"
              (click)="onDistributionPointTapped($event, point)"
            >
              <span *ngIf="point.count > 1">{{ point.count }}</span>
            </button>
          </div>
        </ng-container>

        <ng-template #noChartData>
          <div class="chart-empty-msg">Load players to view the distribution.</div>
        </ng-template>
      </div>
    </div>
  </ion-card>

  <ion-card class="members-card">
    <div class="members-toolbar" [class.single-control]="!showScopeSelect">
      <ion-select
        class="small-select"
        interface="popover"
        [ngModel]="metric"
        (ngModelChange)="onMetricChange($event)"
      >
        <ion-select-option value="total">Sort: Total</ion-select-option>
        <ion-select-option value="cardio">Sort: Cardio</ion-select-option>
        <ion-select-option value="strength">Sort: Strength</ion-select-option>
      </ion-select>

      <div class="members-title">Members</div>

      <ng-container *ngIf="showScopeSelect; else toolbarSpacer">
        <ion-select
          class="small-select"
          interface="popover"
          [ngModel]="scope"
          (ngModelChange)="onScopeChange($event)"
        >
          <ion-select-option value="city">Region: City</ion-select-option>
          <ion-select-option value="state">Region: State</ion-select-option>
          <ion-select-option value="country">Region: Country</ion-select-option>
        </ion-select>
      </ng-container>

      <ng-template #toolbarSpacer>
        <div class="members-toolbar-spacer" aria-hidden="true"></div>
      </ng-template>
    </div>

    <div class="members-body">
      <div class="loading-row" *ngIf="loading">
        <ion-spinner name="crescent"></ion-spinner>
        <div>Loading...</div>
      </div>

      <div class="error-row" *ngIf="!loading && errorMsg">
        {{ errorMsg }}
      </div>

      <ion-list class="members-list" *ngIf="!loading && !errorMsg">
        <div
          class="member-row"
          *ngFor="let e of entries"
          [class.row-highlighted]="isEntryHighlighted(e)"
          tabindex="0"
          role="button"
          (click)="onMemberRowClick(e)"
          (keydown)="onMemberRowKeydown($event, e)"
        >
          <div class="member-left">
            <ion-avatar class="avatar">
              <ng-container *ngIf="hasAvatar(e); else avatarFallback">
                <img
                  [src]="avatarUrl(e)"
                  alt="profile"
                  (error)="onAvatarError(e)"
                />
              </ng-container>
              <ng-template #avatarFallback>
                <div class="avatar-fallback">{{ avatarInitial(e) }}</div>
              </ng-template>
            </ion-avatar>

            <div class="member-name">
              <div class="name-main">
                {{ e.username || e.displayName || 'User' }}
              </div>
              <div class="name-sub" *ngIf="e.role === 'TRAINER'">Trainer: [PT]</div>
            </div>
          </div>

          <div class="member-right">
            <div class="rank">Rank: #{{ e.rank }}</div>
            <div class="score">{{ metricLabel() }}: {{ scoreFor(e) }}</div>
          </div>
        </div>
      </ion-list>
    </div>
  </ion-card>
</div>
