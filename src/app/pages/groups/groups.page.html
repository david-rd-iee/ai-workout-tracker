<ion-content [fullscreen]="true" class="groups-page">
  <section class="top-panel">
    <button class="back-btn" type="button" (click)="goBack()" aria-label="Go back">
      <ion-icon name="arrow-back-outline"></ion-icon>
    </button>

    <h1>Groups</h1>

    <div class="tab-toggle">
      <button
        type="button"
        [class.active]="selectedTab === 'training'"
        [class.disabled]="!trainingEnabled"
        [disabled]="!trainingEnabled"
        (click)="selectTab('training')"
      >
        Training
      </button>
      <button
        type="button"
        [class.active]="selectedTab === 'friends'"
        (click)="selectTab('friends')"
      >
        Friends
      </button>
    </div>
  </section>

  <section class="groups-content">
    <ng-container *ngIf="selectedTab === 'training'; else friendsTab">
      <div class="state-message" *ngIf="trainingLoading">
        <ion-spinner name="crescent"></ion-spinner>
      </div>

      <div class="state-message" *ngIf="!trainingLoading && !trainingEnabled">
        Training leaderboard unavailable.
      </div>

      <app-leaderboard-shell
        *ngIf="!trainingLoading && trainingEnabled && trainingGroup"
        [showTopbar]="false"
        [title]="trainingTitle"
        [graphLabel]="trainingTitle"
        [loading]="trainingLeaderboardLoading"
        [errorMsg]="trainingLeaderboardError || ''"
        [metric]="trainingMetric"
        [showScopeSelect]="false"
        [entries]="trainingEntries"
        [distributionCurvePath]="trainingDistributionCurvePath"
        [distributionPoints]="trainingDistributionPoints"
        [selectedPointBin]="trainingSelectedPointBin"
        [highlightedUserIds]="trainingSelectedPointUserIds"
        (metricChange)="onTrainingMetricChange($event)"
        (distributionPointClick)="onTrainingDistributionPointClick($event)"
        (memberClick)="onTrainingMemberClick($event)"
      ></app-leaderboard-shell>
    </ng-container>

    <ng-template #friendsTab>
      <div class="state-message" *ngIf="loading">
        <ion-spinner name="crescent"></ion-spinner>
      </div>

      <div class="state-message error" *ngIf="!loading && errorMessage">
        {{ errorMessage }}
      </div>

      <div class="state-message" *ngIf="!loading && !errorMessage && friendGroups.length === 0">
        You are not in any friend groups yet.
      </div>

      <div class="card-list" *ngIf="!loading && !errorMessage && friendGroups.length > 0">
        <button
          class="group-card group-card-button"
          [class.owner-highlight]="isOwnedByCurrentUser(group)"
          type="button"
          *ngFor="let group of friendGroups"
          (click)="openGroup(group)"
        >
          <img
            [src]="group.groupImage || 'assets/icons/Icon.png'"
            (error)="$any($event.target).src = 'assets/icons/Icon.png'"
            alt=""
            aria-hidden="true"
          />
          <p>{{ group.name }}</p>
        </button>
      </div>
    </ng-template>
  </section>

  <button
    *ngIf="selectedTab === 'friends'"
    class="add-group-btn"
    type="button"
    (click)="openGroupSearch()"
    aria-label="Search groups"
  >
    <ion-icon name="add-outline"></ion-icon>
  </button>
</ion-content>

<ion-modal [isOpen]="searchModalOpen" (didDismiss)="closeGroupSearch()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button fill="clear" (click)="promptCreateGroup()">Create Group</ion-button>
        </ion-buttons>
        <ion-title>Find Groups</ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" (click)="closeGroupSearch()" aria-label="Close">
            <ion-icon name="close-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="search-modal-content ion-padding">
      <ion-searchbar
        [(ngModel)]="searchQuery"
        placeholder="Search group name"
        autocapitalize="off"
      ></ion-searchbar>

      <div class="state-message" *ngIf="allGroupsLoading">
        <ion-spinner name="crescent"></ion-spinner>
      </div>

      <div class="state-message error" *ngIf="!allGroupsLoading && allGroupsError">
        {{ allGroupsError }}
      </div>

      <div class="state-message" *ngIf="!allGroupsLoading && !allGroupsError && filteredAllGroups.length === 0">
        No groups found.
      </div>

      <div class="search-results" *ngIf="!allGroupsLoading && !allGroupsError && filteredAllGroups.length > 0">
        <button
          class="search-result-item"
          type="button"
          *ngFor="let group of filteredAllGroups"
          (click)="onSearchGroupPressed(group)"
        >
          <img
            [src]="group.groupImage || 'assets/icons/Icon.png'"
            (error)="$any($event.target).src = 'assets/icons/Icon.png'"
            alt=""
            aria-hidden="true"
          />
          <span>{{ group.name }}</span>
        </button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
