<app-header title="Notes" [showBack]="true"></app-header>

<ion-content [fullscreen]="true">
  <div class="background-gradient"></div>

  <div *ngIf="isLoading" class="loading-container ion-padding ion-text-center">
    <ion-spinner></ion-spinner>
    <p>Loading notes...</p>
  </div>

  <app-session-notes 
    [clientId]="isTrainer ? receiverId : uid" 
    [trainerId]="isTrainer ? uid : receiverId"
    [selectedDate]="dateFromQueryParams">
  </app-session-notes>

  <div *ngIf="!isLoading && notes.length === 0" class="empty-state ion-padding ion-text-center">
    <ion-icon name="document-text-outline" size="large"></ion-icon>
    <h2>No notes available</h2>
    <p *ngIf="isTrainer">Tap the + button to add your first note</p>
    <p *ngIf="!isTrainer">Your trainer hasn't added any notes yet</p>
  </div>

  <div *ngIf="!isLoading && notes.length > 0" class="notes-container ion-padding">
    <ion-card *ngFor="let note of generalNotes" class="note-card">
      <ion-card-header class="note-header-container">
        <ion-card-title *ngIf="!isTrainer">{{ note.title }}</ion-card-title>
        
        <div *ngIf="isTrainer" class="trainer-header">
          <div *ngIf="isEditingTitle !== note.id" class="editable-title" (click)="editNoteTitle(note)">
            <ion-card-title>
              {{ note.title }}
              <ion-icon name="pencil-outline" size="small" class="edit-icon"></ion-icon>
            </ion-card-title>
          </div>
          
          <div *ngIf="isEditingTitle === note.id" class="title-editor">
            <ion-input [(ngModel)]="editableTitle" (keyup.enter)="saveNoteTitle(note)" (ionBlur)="saveNoteTitle(note)" placeholder="Enter title" class="title-input" autofocus></ion-input>
          </div>
          
            <ion-button fill="clear" (click)="deleteNote(note)" size="small" class="delete-button">
            <ion-icon name="trash-outline" color="danger"></ion-icon>
          </ion-button>
        </div>
      </ion-card-header>
      
      <ion-card-content [class.editing]="isEditingContent === note.id">
        <ion-list *ngIf="isEditingContent !== note.id && isTrainer" lines="none" class="note-list editable-content" (click)="editNoteContent(note)">
          <ion-item *ngFor="let item of note.content">
            <ion-icon name="ellipse" size="small" class="bullet-point"></ion-icon>
            <ion-label class="note-item">{{ item }}</ion-label>
          </ion-item>
        </ion-list>
        
        <ion-list *ngIf="isEditingContent !== note.id && !isTrainer" lines="none" class="note-list">
          <ion-item *ngFor="let item of note.content">
            <ion-icon name="ellipse" size="small" class="bullet-point"></ion-icon>
            <ion-label class="note-item">{{ item }}</ion-label>
          </ion-item>
        </ion-list>
        
        <div *ngIf="isTrainer && isEditingContent === note.id" class="content-editor">
          <ion-textarea [(ngModel)]="editableContent" rows="5" placeholder="Enter note content (one item per line)" class="content-textarea"></ion-textarea>
          <div class="editor-actions">
            <ion-button size="small" (click)="saveNoteContent(note)" color="success">
              <ion-icon name="checkmark-outline" slot="start"></ion-icon>
              Save
            </ion-button>
            <ion-button size="small" fill="outline" (click)="cancelContentEdit()" color="medium">
              <ion-icon name="close-outline" slot="start"></ion-icon>
              Cancel
            </ion-button>
          </div>
        </div>

        <div class="files-section" *ngIf="noteFiles.get(note.id)?.length">
          <h4 class="files-heading">Attachments</h4>
          <div class="files-list">
            <div *ngFor="let file of noteFiles.get(note.id)" class="file-item">
              <app-file-preview
                [fileUrl]="file.fileUrl"
                [fileName]="file.fileName"
                [fileType]="file.fileType"
                [fileId]="file.id"
                [filePath]="file.filePath || ''"
                [canDelete]="isTrainer || uid === file.uploadedBy"
                (deleteFile)="deleteNoteFile($event, note.id)">
              </app-file-preview>
            </div>
          </div>
        </div>

        <div class="loading-files" *ngIf="loadingFiles.get(note.id)">
          <ion-spinner name="dots" color="medium"></ion-spinner>
          <span>Loading attachments...</span>
        </div>
        <div class="note-footer" *ngIf="isTrainer">
          <ion-button class="visibility-toggle" [color]="note.showToClient ? 'primary' : 'medium'" (click)="toggleShowToClient(note)" size="default" fill="outline">
            <ion-icon [name]="note.showToClient ? 'eye-outline' : 'eye-off-outline'" slot="start"></ion-icon>
            {{ note.showToClient ? 'Hide from Client' : 'Show to Client' }}
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>

  </div>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="isTrainer">
    <ion-fab-button color="primary">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
    <ion-fab-list side="top">
      <ion-fab-button (click)="addNewNote()" color="light">
        <ion-icon name="create-outline" color="primary"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="addFile(null)" color="light">
        <ion-icon name="document-attach-outline" color="primary"></ion-icon>
      </ion-fab-button>
      <ion-fab-button (click)="takePicture(null)" color="light">
        <ion-icon name="camera-outline" color="primary"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>
</ion-content>
